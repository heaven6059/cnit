<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cnit.yoyo.dao.member.RolesMapper" >
  <resultMap id="BaseResultMap" type="com.cnit.yoyo.model.member.Roles" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    <id column="roles_id" property="rolesId" jdbcType="BIGINT" />
    <result column="roles_name" property="rolesName" jdbcType="VARCHAR" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="company_id" property="companyId" jdbcType="BIGINT" />
    <result column="store_id" property="storeId" jdbcType="BIGINT" />
    <result column="regtime" property="regtime" jdbcType="BIGINT" />
    <result column="last_modify_time" property="lastModifyTime" jdbcType="BIGINT" />
    <result column="disabled" property="disabled" jdbcType="VARCHAR" />
  </resultMap>
  <resultMap id="ResultMapWithBLOBs" type="com.cnit.yoyo.model.member.Roles" extends="BaseResultMap" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    <result column="workground" property="workground" jdbcType="LONGVARCHAR" />
  </resultMap>
  
  <resultMap type="com.cnit.yoyo.model.system.dto.SiteRoleListDTO" id="roleResourceDTO" extends="BaseResultMap">  
	  <result column="RESOURCE_NAME" property="resourceName" jdbcType="VARCHAR" />
	  <result column="company_name" property="companyName" jdbcType="VARCHAR" />
	  <result column="shop_name" property="storeName" jdbcType="VARCHAR" />
  </resultMap>
  
   <resultMap type="com.cnit.yoyo.model.member.dto.RolesDTO" id="rolesDTO" extends="BaseResultMap">  
	  <result column="store_name" property="storeName" jdbcType="VARCHAR" />
	  <result column="shop_name" property="shopName" jdbcType="VARCHAR" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    roles_id, roles_name, description,company_id, store_id, regtime, last_modify_time,disabled
  </sql>
  <sql id="Blob_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    workground
  </sql>
  <select id="selectByPrimaryKey" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from t_business_storeroles
    where roles_id = #{rolesId,jdbcType=BIGINT}
  </select>
  
  <select id="selectAllRoleResource" resultMap="roleResourceDTO">
    SELECT
	t_business_storeroles.roles_id,
	t_business_storeroles.roles_name,
	t_business_storeroles.description,
	t_company.company_name,
	t_business_storemanger.shop_name,
	t_site_resource.RESOURCE_NAME
	FROM
	t_business_storeroles
	JOIN t_storeroles_resource ON t_storeroles_resource.roles_id = t_business_storeroles.roles_id
	JOIN t_site_resource ON t_site_resource.ID = t_storeroles_resource.resource_id
	JOIN t_company ON t_company.company_id = t_business_storeroles.company_id
	JOIN t_business_storemanger ON t_business_storemanger.store_id = t_business_storeroles.store_id
  </select>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    delete from t_business_storeroles
    where roles_id = #{rolesId,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.cnit.yoyo.model.member.Roles" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    insert into t_business_storeroles (roles_id, roles_name, description,company_id, 
      store_id, regtime, last_modify_time, workground
      ) 
    values (#{rolesId,jdbcType=BIGINT}, #{rolesName,jdbcType=VARCHAR}, #{description,jdbcType=VARCHAR},#{companyId,jdbcType=BIGINT}, 
      #{storeId,jdbcType=BIGINT}, #{regtime,jdbcType=BIGINT}, #{lastModifyTime,jdbcType=BIGINT},  #{workground,jdbcType=LONGVARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.cnit.yoyo.model.member.Roles" useGeneratedKeys="true" keyProperty="roles_id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    insert into t_business_storeroles
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="rolesId != null" >
        roles_id,
      </if>
      <if test="rolesName != null" >
        roles_name,
      </if>
      <if test="description != null" >
        description,
      </if>
      <if test="companyId != null" >
        company_id,
      </if>
      <if test="storeId != null" >
        store_id,
      </if>
      <if test="regtime != null" >
        regtime,
      </if>
      <if test="lastModifyTime != null" >
        last_modify_time,
      </if>
      <if test="workground != null" >
        workground,
      </if>
      <if test="disabled!=null and disabled!=''">
      	disabled,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="rolesId != null" >
        #{rolesId,jdbcType=BIGINT},
      </if>
      <if test="rolesName != null" >
        #{rolesName,jdbcType=VARCHAR},
      </if>
      <if test="description != null" >
        #{description,jdbcType=VARCHAR},
      </if>
      <if test="companyId != null" >
        #{companyId,jdbcType=BIGINT},
      </if>
      <if test="storeId != null" >
        #{storeId,jdbcType=BIGINT},
      </if>
      <if test="regtime != null" >
        #{regtime,jdbcType=BIGINT},
      </if>
      <if test="lastModifyTime != null" >
        #{lastModifyTime,jdbcType=BIGINT},
      </if>
      <if test="workground != null" >
        #{workground,jdbcType=LONGVARCHAR},
      </if>
        <if test="disabled!=null and disabled!=''">
      	 #{disabled,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.cnit.yoyo.model.member.Roles" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    update t_business_storeroles
    <set >
      <if test="rolesName != null" >
        roles_name = #{rolesName,jdbcType=VARCHAR},
      </if>
      <if test="description != null" >
        description = #{description,jdbcType=VARCHAR},
      </if>
      <if test="companyId != null" >
        company_id = #{companyId,jdbcType=BIGINT},
      </if>
      <if test="storeId != null" >
        store_id = #{storeId,jdbcType=BIGINT},
      </if>
      <if test="regtime != null" >
        regtime = #{regtime,jdbcType=BIGINT},
      </if>
      <if test="disabled != null and disabled!=''" >
        disabled = #{disabled,jdbcType=VARCHAR},
      </if>
      <if test="lastModifyTime != null" >
        last_modify_time = #{lastModifyTime,jdbcType=BIGINT},
      </if>
      <if test="workground != null" >
        workground = #{workground,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where roles_id = #{rolesId,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.cnit.yoyo.model.member.Roles" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    update t_business_storeroles
    set roles_name = #{rolesName,jdbcType=VARCHAR},
    description = #{description,jdbcType=VARCHAR},
      company_id = #{companyId,jdbcType=BIGINT},
      store_id = #{storeId,jdbcType=BIGINT},
      regtime = #{regtime,jdbcType=BIGINT},
       disabled = #{disabled,jdbcType=VARCHAR},
      last_modify_time = #{lastModifyTime,jdbcType=BIGINT},
      workground = #{workground,jdbcType=LONGVARCHAR}
    where roles_id = #{rolesId,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.cnit.yoyo.model.member.Roles" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    update t_business_storeroles
    set roles_name = #{rolesName,jdbcType=VARCHAR},
    description = #{description,jdbcType=VARCHAR},
      company_id = #{companyId,jdbcType=BIGINT},
      store_id = #{storeId,jdbcType=BIGINT},
      regtime = #{regtime,jdbcType=BIGINT},
       disabled = #{disabled,jdbcType=VARCHAR},
      last_modify_time = #{lastModifyTime,jdbcType=BIGINT}
    where roles_id = #{rolesId,jdbcType=BIGINT}
  </update>
  
    <select id="findRolesNameById" parameterType="com.cnit.yoyo.model.member.Roles" resultMap="BaseResultMap">
  		select roles_id,roles_name from t_business_storeroles
  </select>
  
  	<resultMap id="roleDTOResultMap" type="com.cnit.yoyo.model.member.dto.RolesDTO">
		<id column="roles_id" property="rolesId" jdbcType="BIGINT" />
	    <result column="roles_name" property="rolesName" jdbcType="VARCHAR" />
	    <result column="company_id" property="companyId" jdbcType="BIGINT" />
	    <result column="store_id" property="storeId" jdbcType="BIGINT" />
	    <result column="regtime" property="regtime" jdbcType="BIGINT" />
	    <result column="last_modify_time" property="lastModifyTime" jdbcType="BIGINT" />
		<result column="workground" property="workground" jdbcType="LONGVARCHAR" />
		<result column="member_count" property="memberCount" jdbcType="INTEGER" />
	</resultMap>
  
  <select id="findByStoreId" resultMap="roleDTOResultMap">
  	SELECT
    <include refid="Base_Column_List" />,
    (SELECT count(0) from t_business_storemember WHERE role_id=T_BUSINESS_STOREROLES.roles_id) as member_count
    FROM T_BUSINESS_STOREROLES 
    WHERE STORE_ID = #{storeId,jdbcType=BIGINT}
    and disabled = 0
    order by regtime desc
  </select>
  
  <select id="findSelect" resultMap="BaseResultMap" parameterType="java.lang.Long">
    select 
    roles_id, roles_name
    from T_BUSINESS_STOREROLES
     where company_id = #{_parameter,jdbcType=BIGINT} and disabled='0'
  </select>
  
  <select id="findByStoreAndName" resultMap="roleDTOResultMap">
  	SELECT
    <include refid="Base_Column_List" />
    FROM T_BUSINESS_STOREROLES 
    WHERE STORE_ID = #{0} AND ROLES_NAME = #{1} and disabled='0'
  </select>
  
    <select id="findRoleByUserName" resultMap="BaseResultMap" parameterType="java.lang.String">
  	SELECT
	t_business_storeroles.roles_id,
	t_business_storeroles.roles_name,
	t_business_storeroles.workground,
	t_business_storeroles.company_id,
	t_business_storeroles.store_id,
	t_business_storeroles.regtime,
	t_business_storeroles.last_modify_time
	FROM
	t_business_storeroles
	JOIN t_business_storemember ON t_business_storeroles.roles_id = t_business_storemember.role_id
	JOIN t_members ON t_business_storemember.member_id = t_members.MEMBER_ID
	JOIN t_pam_account ON t_members.ACCOUNT_ID = t_pam_account.ACCOUNT_ID
	where t_pam_account.LOGIN_NAME = #{loginName,jdbcType=VARCHAR}
  </select>
  
  <update id="updateNameByRolesId"  >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 13 16:52:56 CST 2015.
    -->
    update t_business_storeroles 
    set roles_name = #{1} ,last_modify_time = #{2} 
    where roles_id = #{0}
  </update>
  
  <delete id="deleteByRolesIdAndStore" >
    delete from t_business_storeroles
    where roles_id = #{0} and store_id = #{1}
  </delete>
  
  <!-- 店铺管理中：获取所有店铺角色 -->
  <select id="findShopAllRoles" resultMap="rolesDTO" parameterType="com.cnit.yoyo.model.member.dto.RolesDTO">
  	SELECT tbs.*,tbm.store_name,tbm.shop_name FROM t_business_storeroles tbs JOIN t_business_storemanger tbm
 	ON (tbs.company_id=tbm.company_id and tbs.store_id=tbm.store_id)  where tbs.disabled='0' 
 	<if test="rolesName!=null and rolesName!=''">
 		and tbs.roles_name like CONCAT('%',#{rolesName,jdbcType=VARCHAR},'%')
 	</if>
 	<if test="storeName!=null and storeName!=''">
 		and tbm.store_name like CONCAT('%',#{storeName,jdbcType=VARCHAR},'%')
 	</if>
 	<if test="shopName!=null and shopName!=''">
 		and tbm.shop_name like CONCAT('%',#{shopName,jdbcType=VARCHAR},'%')
 	</if>
	 <if test="regtimeStart != null and regtimeStart!=''">
		and	<![CDATA[ left(from_unixtime(left(regtime,10)),11) >= date_format(#{regtimeStart,jdbcType=VARCHAR},'%Y-%m-%d')]]>
	</if>
	<if test="regtimeEnd != null and regtimeEnd!=''">
		and	<![CDATA[ left(from_unixtime(left(regtime,10)),11)<=date_format(#{regtimeEnd,jdbcType=VARCHAR},'%Y-%m-%d')]]>
	</if>
	
	<if test="orderStmt != null and orderStmt!=''">
		ORDER BY ${orderStmt}
	</if>
  </select>
  
   <update id="deleteRole" >
    update t_business_storeroles 
    set disabled = '1'
    where roles_id in 
    <foreach collection="array" item="item" index="index" open="(" close=")" separator=",">
    	#{item}
    </foreach>
  </update>
  
</mapper>
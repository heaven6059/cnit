<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cnit.yoyo.dao.member.ClerkInfoMapper" >
  <resultMap id="BaseResultMap" type="com.cnit.yoyo.domain.member.ClerkInfoDo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Mar 11 18:44:21 CST 2015.
    -->
    <result column="attach_id" property="attachId" jdbcType="BIGINT"/>
    <result column="login_name" property="loginName" jdbcType="VARCHAR"/>
    <result column="name" property="name" jdbcType="VARCHAR"/>
    <result column="tel" property="tel" jdbcType="VARCHAR" />
    <result column="email" property="email" jdbcType="VARCHAR" />
    <result column="reg_time" property="regTime" jdbcType="VARCHAR" />
    <result column="roles_name" property="rolesName" jdbcType="VARCHAR" />
    <result column="store_name" property="storeName" jdbcType="VARCHAR" />
    <result column="roles_id" property="roleId" jdbcType="BIGINT" />
    <result column="store_id" property="storeId" jdbcType="BIGINT" />
    <result column="shopkeeper" property="shopkeeper" jdbcType="VARCHAR" />
    <result column="shop_name" property="shopName" jdbcType="VARCHAR" />
    <result column="last_modify" property="lastModify" jdbcType="VARCHAR" />
  </resultMap>
  	<select id="findClerksInfo" parameterType="com.cnit.yoyo.domain.member.ClerkInfoDo" resultMap="BaseResultMap">
		SELECT b.attach_id,r.roles_id,p.LOGIN_NAME,ROLES_NAME,t.NAME,t.EMAIL ,t.TEL,p.REG_TIME,tbsm.store_name,b.store_id FROM T_MEMBERS t, 
		t_business_storemember b,t_business_storeroles r,t_pam_account p ,t_business_storemanger tbsm
		WHERE t.MEMBER_ID=b.MEMBER_ID AND b.ROLE_ID=r.ROLES_ID AND t.ACCOUNT_ID=p.ACCOUNT_ID and tbsm.store_id = b.store_id
		AND b.disabled = '0' and b.commany_id=#{companyId,jdbcType=BIGINT} 
		<!-- and b.store_id=#{storeId,jdbcType=BIGINT}  暂时不处理分店-->
		<if test="loginName != null"> AND p.LOGIN_NAME = #{loginName,jdbcType=VARCHAR}</if>
		<if test="name != null"> AND t.NAME = #{name,jdbcType=VARCHAR}</if>
		<if test="tel != null"> AND t.TEL = #{tel,jdbcType=VARCHAR}</if>
		<if test="email != null"> AND t.EMAIL = #{email,jdbcType=VARCHAR}</if>
		<if test="regTime != null"> AND p.REG_TIME = #{regTime,jdbcType=VARCHAR}  </if>
		<if test="rolesName != null"> AND r.ROLES_NAME = #{rolesName,jdbcType=VARCHAR}</if>
		
	</select>
	
	<!-- 平台店铺管理中店员列表 ：先查店主，再查店员-->
	<select id="findAllClerks" parameterType="com.cnit.yoyo.model.goods.dto.ClerksDTO" resultMap="BaseResultMap">
		SELECT a.LOGIN_NAME as shopkeeper,b.* from 
		
		(SELECT pa.LOGIN_NAME,tmb.store_id from t_business_storemember tmb JOIN t_business_storemanger tbm ON tmb.store_id=tbm.store_id JOIN t_pam_account pa ON tbm.account_id=pa.ACCOUNT_ID WHERE tmb.disabled='0' and tmb.type='1'
			<if test="shopkeeper !=null and shopkeeper!=''">
				AND  pa.LOGIN_NAME like CONCAT('%',#{shopkeeper,jdbcType=VARCHAR},'%')
			</if>
		) a,
		
		(SELECT tpa.LOGIN_NAME, tsr.DESCRIPTION as roleName,tbm.shop_name,tbm.store_name,tbs.* from t_business_storemember tbs JOIN t_business_storemanger tbm ON tbs.store_id=tbm.store_id
		JOIN t_members tm ON tm.MEMBER_ID=tbs.member_id JOIN t_pam_account tpa ON tpa.ACCOUNT_ID=tm.ACCOUNT_ID 
		LEFT JOIN t_site_roles tsr ON tsr.ROLE_ID=tbs.role_id WHERE tbs.disabled='0' and tbs.type='0' 
		<if test="loginName !=null and !''.equals(loginName.trim())">
			AND tpa.LOGIN_NAME like CONCAT('%',#{loginName,jdbcType=VARCHAR},'%')
		</if>
		
		<if test="shopName !=null and !''.equals(shopName.trim())">
			AND tbm.shop_name like CONCAT('%',#{shopName,jdbcType=VARCHAR},'%')
		</if>
		
		<if test="storeName !=null and !''.equals(storeName.trim())">
			AND tbm.store_name like CONCAT('%',#{storeName,jdbcType=VARCHAR},'%')
		</if>
		
		<if test="rolesName !=null and !''.equals(rolesName.trim())">
			AND tsr.DESCRIPTION like CONCAT('%',#{rolesName,jdbcType=VARCHAR},'%')
		</if>
		
		) b WHERE a.store_id = b.store_id
		
	</select>


	<!-- 删除店员 -->
	<update id="batchDeleteClerks">
		UPDATE t_business_storemember set disabled='1' WHERE attach_id IN
		<foreach collection="array" index="index" item="item" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</update>
</mapper>